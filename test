<?php

namespace App\Http\Controllers\Seller\RegisterSeller;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use App\Models\Shop;
use App\Models\ShopAddress;
use App\Models\ShopShippingOption;
use App\Models\BusinessLicense;
use App\Models\Seller;
use App\Models\User;
use App\Models\Notification;
use App\Models\IdentityVerification;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class RegisterShopController extends Controller
{
    /**
     * Kiểm tra nếu đã là seller thì không cho vào đăng ký lại
     */
    private function checkAlreadySeller()
    {
        if (\App\Models\Seller::where('userID', Auth::id())->exists()) {
            return redirect()->route('seller.home')->withErrors(['error' => 'Bạn đã đăng ký trở thành người bán. Không thể đăng ký lại.']);
        }
        return null;
    }

    /**
     * Hiển thị Trang 1: Thông tin shop
     */
    public function showStep1()
    {
        if ($redirect = $this->checkAlreadySeller()) return $redirect;
        return view('seller.register.register');
    }

    /**
     * Xử lý dữ liệu Trang 1
     */
    public function step1(Request $request)
    {
        $request->validate([
            'shop_name' => 'required|unique:shops,shop_name|max:100',
            'email' => 'required|email|unique:shops,shop_email|max:100',
            'phone' => 'required|unique:shops,shop_phone|max:11',
            'address' => 'required|max:255',
            // Đã bỏ validate các trường địa phương
            'shop_description' => 'required|max:65535',
            'shop_logo' => 'required|file|image|mimes:jpg,jpeg,png|max:2048',
            'shop_banner' => 'required|file|image|mimes:jpg,jpeg,png|max:4096',
        ], [
            'shop_name.required' => 'Tên shop là bắt buộc.',
            'shop_name.unique' => 'Tên shop đã tồn tại.',
            'email.required' => 'Email là bắt buộc.',   
            'email.unique' => 'Email đã được sử dụng.',
            'phone.required' => 'Số điện thoại là bắt buộc.',
            'phone.unique' => 'Số điện thoại đã được sử dụng.',
            'address.required' => 'Địa chỉ lấy hàng là bắt buộc.',
            // Đã bỏ thông báo lỗi các trường địa phương
            'shop_description.required' => 'Mô tả shop là bắt buộc.',
            'shop_logo.required' => 'Logo shop là bắt buộc.',
            'shop_logo.max' => 'Logo shop không được vượt quá 2MB.',
            'shop_banner.required' => 'Banner shop là bắt buộc.',
            'shop_banner.max' => 'Banner shop không được vượt quá 4MB.',
        ]);

        // Lưu file logo và banner
        $logoPath = $request->file('shop_logo')->store('shop_logos', 'public');
        $bannerPath = $request->file('shop_banner')->store('shop_banners', 'public');

        // Lưu dữ liệu vào session
        session(['register_shop' => array_merge(session('register_shop', []), [
            'shop_name' => $request->shop_name,
            'shop_email' => $request->email,
            'shop_phone' => $request->phone,
            'shop_address' => $request->address,
            // Đã bỏ lưu các trường địa phương
            'shop_description' => $request->shop_description,
            'shop_logo' => $logoPath,
            'shop_banner' => $bannerPath,
        ])]);

        return redirect()->route('seller.register.step2')->with('success', 'Thông tin shop đã được lưu tạm.');
    }

    /**
     * Hiển thị Trang 2: Dịch vụ vận chuyển
     */
    public function showStep2()
    {
        if ($redirect = $this->checkAlreadySeller()) return $redirect;
        // Kiểm tra dữ liệu session từ Trang 1
        if (!session('register_shop.shop_name')) {
            return redirect()->route('seller.register.step1')->withErrors(['error' => 'Vui lòng hoàn thành bước 1 trước.']);
        }
        return view('seller.register.register1');
    }

    /**
     * Xử lý dữ liệu Trang 2
     */
    public function step2(Request $request)
    {
        $request->validate([
            'shipping_options.express.cod_enabled' => 'nullable|boolean',
            'shipping_options.fast.cod_enabled' => 'nullable|boolean',
            'shipping_options.economy.cod_enabled' => 'nullable|boolean',
            'shipping_options.self_pickup.cod_enabled' => 'nullable|boolean',
            'shipping_options.bulky.cod_enabled' => 'nullable|boolean',
        ]);

        // Lưu dữ liệu vận chuyển vào session
        session(['register_shop' => array_merge(session('register_shop', []), [
            'shipping_options' => [
                'express' => ['cod_enabled' => $request->input('shipping_options.express.cod_enabled', 0)],
                'fast' => ['cod_enabled' => $request->input('shipping_options.fast.cod_enabled', 0)],
                'economy' => ['cod_enabled' => $request->input('shipping_options.economy.cod_enabled', 0)],
                'self_pickup' => ['cod_enabled' => $request->input('shipping_options.self_pickup.cod_enabled', 0)],
                'bulky' => ['cod_enabled' => $request->input('shipping_options.bulky.cod_enabled', 0)],
            ],
        ])]);

        return redirect()->route('seller.register.step3')->with('success', 'Cấu hình vận chuyển đã được lưu tạm.');
    }

    /**
     * Hiển thị Trang 3: Thông tin kinh doanh
     */
    public function showStep3()
    {
        if ($redirect = $this->checkAlreadySeller()) return $redirect;
        // Kiểm tra dữ liệu session từ Trang 2
        if (!session('register_shop.shipping_options')) {
            return redirect()->route('seller.register.step2')->withErrors(['error' => 'Vui lòng hoàn thành bước 2 trước.']);
        }
        return view('seller.register.register2');
    }

    /**
     * Xử lý dữ liệu Trang 3
     */
    public function step3(Request $request)
    {
        $request->validate([
            'business_type' => 'required|in:personal,household,company',
            'business_province' => 'required',
            'business_district' => 'required',
            'business_ward' => 'required',
            'business_address_detail' => 'required|max:255',
            'invoice_email' => 'required|email|max:100',
            'tax_code' => 'required|max:20',
        ], [
            'business_type.required' => 'Loại hình kinh doanh là bắt buộc.',
            'business_province.required' => 'Tỉnh/thành phố là bắt buộc.',
            'business_district.required' => 'Quận/huyện là bắt buộc.',
            'business_ward.required' => 'Phường/xã là bắt buộc.',
            'business_address_detail.required' => 'Địa chỉ kinh doanh là bắt buộc.',
            'invoice_email.required' => 'Email nhận hóa đơn là bắt buộc.',
            'tax_code.required' => 'Mã số thuế là bắt buộc.',
        ]);

        // Gộp địa chỉ kinh doanh
        $business_province_name = $this->getNameFromApi('province', $request->business_province) ?? '';
        $business_district_name = $this->getNameFromApi('district', $request->business_district) ?? '';
        $business_ward_name = $this->getNameFromApi('ward', $request->business_ward) ?? '';

        $business_address = $request->business_address_detail . ', ';
        $business_address .= $business_ward_name . ', ';
        $business_address .= $business_district_name . ', ';
        $business_address .= $business_province_name;

        // Lưu dữ liệu kinh doanh vào session
        session(['register_shop' => array_merge(session('register_shop', []), [
            'business_type' => $request->business_type,
            'business_province' => $request->business_province,
            'business_district' => $request->business_district,
            'business_ward' => $request->business_ward,
            'business_province_name' => $business_province_name,
            'business_district_name' => $business_district_name,
            'business_ward_name' => $business_ward_name,
            'business_address_detail' => $request->business_address_detail,
            'business_address' => $business_address,
            'invoice_email' => $request->invoice_email,
            'tax_code' => $request->tax_code,
        ])]);

        return redirect()->route('seller.register.step4')->with('success', 'Thông tin kinh doanh đã được lưu tạm.');
    }

    /**
     * Hiển thị Trang 4: Thông tin định danh
     */
    public function showStep4()
    {
        if ($redirect = $this->checkAlreadySeller()) return $redirect;
        // Kiểm tra dữ liệu session từ Trang 3
        if (!session('register_shop.business_type')) {
            return redirect()->route('seller.register.step3')->withErrors(['error' => 'Vui lòng hoàn thành bước 3 trước.']);
        }
        return view('seller.register.register3');
    }

    /**
     * Hoàn tất và lưu dữ liệu vào database
     */
    public function finish(Request $request)
    {
        // Debug: Log request data
        Log::info('Finish request received', [
            'action' => $request->input('action'),
            'has_files' => $request->hasFile('front_cccd_image'),
            'all_data' => $request->all()
        ]);

        // Kiểm tra nếu người dùng đã nhấn nút "Quét CCCD"
        if ($request->input('action') === 'scan_ocr') {
            $request->validate([
                'front_cccd_image' => 'required|file|image|mimes:jpg,jpeg,png|max:2048',
                'back_cccd_image' => 'required|file|image|mimes:jpg,jpeg,png|max:2048',
            ], [
                'front_cccd_image.required' => 'Ảnh mặt trước CCCD là bắt buộc.',
                'front_cccd_image.image' => 'File tải lên phải là ảnh.',
                'front_cccd_image.mimes' => 'Ảnh mặt trước CCCD phải có định dạng jpg, jpeg hoặc png.',
                'front_cccd_image.max' => 'Ảnh mặt trước CCCD không được vượt quá 2MB.',
                'back_cccd_image.required' => 'Ảnh mặt sau CCCD là bắt buộc.',
                'back_cccd_image.image' => 'File tải lên phải là ảnh.',
                'back_cccd_image.mimes' => 'Ảnh mặt sau CCCD phải có định dạng jpg, jpeg hoặc png.',
                'back_cccd_image.max' => 'Ảnh mặt sau CCCD không được vượt quá 2MB.',
            ]);

            $frontImage = $request->file('front_cccd_image');
            $backImage = $request->file('back_cccd_image');

            // Lưu ảnh tạm thời để gọi API
            $frontImagePath = $frontImage->store('temp_cccd_images', 'public');
            $backImagePath = $backImage->store('temp_cccd_images', 'public');

            $fullFrontImagePath = storage_path('app/public/' . $frontImagePath);
            $fullBackImagePath = storage_path('app/public/' . $backImagePath);

            // Gọi API OCR Python
            $apiUrl = 'http://127.0.0.1:5000/process_cccd';
            $curl = curl_init();

            curl_setopt_array($curl, [
                CURLOPT_URL => $apiUrl,
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_POST => true,
                CURLOPT_POSTFIELDS => [
                    'front_image' => new \CURLFile(storage_path('app/public/' . $frontImagePath)),
                    'back_image' => new \CURLFile(storage_path('app/public/' . $backImagePath)),
                ],
            ]);

            $response = curl_exec($curl);
            $httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
            curl_close($curl);

            // Xóa ảnh tạm thời
            \Illuminate\Support\Facades\Storage::disk('public')->delete([$frontImagePath, $backImagePath]);

            if ($httpCode !== 200 || !$response) {
                return back()->withErrors(['ocr_error' => 'Không thể kết nối đến dịch vụ OCR hoặc có lỗi xảy ra. Vui lòng thử lại sau.'])->withInput();
            }

            $ocrData = json_decode($response, true);
            // Kiểm tra lỗi trả về từ API Python
            if (isset($ocrData['error'])) {
                $errorMsg = 'Ảnh quá mờ hoặc thiếu thông tin, không nhận diện được đầy đủ. Vui lòng chụp lại ảnh rõ hơn.';
                if (!empty($ocrData['missing_fields'])) {
                    $errorMsg .= ' Thiếu trường: ' . implode(', ', $ocrData['missing_fields']);
                }
                return back()->withErrors(['ocr_error' => $errorMsg])->withInput();
            }

            if (json_last_error() !== JSON_ERROR_NONE || !is_array($ocrData)) {
                return back()->withErrors(['ocr_error' => 'Dữ liệu OCR trả về không hợp lệ. Vui lòng thử lại.'])->withInput();
            }

            // Trích xuất dữ liệu từ API response (cấu trúc phẳng)
            $identityData = [
                'identity_card' => $ocrData['identity_number'] ?? null,
                'full_name' => $ocrData['full_name'] ?? null,
                'birth_date' => isset($ocrData['birth_date']) ? Carbon::createFromFormat('Y-n-j', $ocrData['birth_date'])->format('Y-m-d') : null,
                'nationality' => $ocrData['nationality'] ?? 'Vietnam',
                'hometown' => $ocrData['hometown'] ?? null,
                'residence' => $ocrData['residence'] ?? null,
                'identity_card_image' => $frontImagePath,
                'identity_card_holding_image' => $backImagePath,
                'privacy_policy_agreed' => 0,
                'identity_card_type' => 'cccd',
                'gender' => $ocrData['gender'] ?? null,
                'identity_card_date' => isset($ocrData['identity_card_date']) ? Carbon::createFromFormat('Y-n-j', $ocrData['identity_card_date'])->format('Y-m-d') : null,
                'identity_card_place' => $ocrData['identity_card_place'] ?? null,
                'dac_diem_nhan_dang' => $ocrData['dac_diem_nhan_dang'] ?? null,
            ];

            // Lưu dữ liệu OCR vào session
            session(['register_shop' => array_merge(session('register_shop', []), $identityData)]);

            return redirect()->route('seller.register.step4')->with('success', 'Thông tin định danh đã được quét. Vui lòng kiểm tra và xác nhận.');

        } else {
            // Nếu không phải là yêu cầu quét OCR, tức là người dùng đang cố gắng submit form thông tin định danh
            Log::info('Finish normal form submission', [
                'request_data' => $request->all(),
                'session_data' => session('register_shop')
            ]);

            // Kiểm tra xem có dữ liệu OCR trong session không
            $hasOcrData = session('register_shop.identity_card');
            
            if ($hasOcrData) {
                // Nếu có dữ liệu OCR, chỉ cần validate checkbox confirm
                $request->validate([
                    'confirm' => 'required',
                ], [
                    'confirm.required' => 'Bạn phải xác nhận thông tin.',
                ]);

                // Cập nhật privacy_policy_agreed trong session
                session(['register_shop' => array_merge(session('register_shop'), [
                    'privacy_policy_agreed' => 1,
                ])]);
            } else {
                // Nếu không có dữ liệu OCR, validate tất cả các trường
                $validationRules = [
                    'id_number' => 'required|string|max:20',
                    'full_name' => 'required|string|max:100',
                    'birthday' => 'nullable|date',
                    'nationality' => 'required|string|max:100',
                    'hometown' => 'required|string|max:255',
                    'residence' => 'required|string|max:255',
                    'gender' => 'required|string|max:10',
                    'identity_card_date' => 'required|date',
                    'identity_card_place' => 'required|string|max:255',
                    'dac_diem_nhan_dang' => 'nullable|string|max:255',
                ];

                $validationMessages = [
                    'id_number.required' => 'Số CCCD là bắt buộc.',
                    'full_name.required' => 'Họ và tên là bắt buộc.',
                    'birthday.date' => 'Ngày sinh không đúng định dạng.',
                    'nationality.required' => 'Quốc tịch là bắt buộc.',
                    'hometown.required' => 'Quê quán là bắt buộc.',
                    'residence.required' => 'Nơi thường trú là bắt buộc.',
                    'gender.required' => 'Giới tính là bắt buộc.',
                    'identity_card_date.required' => 'Ngày cấp là bắt buộc.',
                    'identity_card_place.required' => 'Nơi cấp là bắt buộc.',
                ];

                $request->validate($validationRules, $validationMessages);

                // Lưu dữ liệu thủ công vào session
                session(['register_shop' => array_merge(session('register_shop', []), [
                    'identity_card' => $request->id_number,
                    'full_name' => $request->full_name,
                    'birth_date' => $request->birthday,
                    'nationality' => $request->nationality,
                    'hometown' => $request->hometown,
                    'residence' => $request->residence,
                    'privacy_policy_agreed' => 1,
                    'gender' => $request->gender,
                    'identity_card_date' => $request->identity_card_date,
                    'identity_card_place' => $request->identity_card_place,
                    'dac_diem_nhan_dang' => $request->dac_diem_nhan_dang,
                    'identity_card_type' => 'cccd',
                ])]);
            }

            // Tiếp tục với việc lưu dữ liệu vào database
            $data = session('register_shop');
            
            if (!$data) {
                return redirect()->route('seller.register.step1')->withErrors(['error' => 'Không tìm thấy dữ liệu đăng ký. Vui lòng thử lại.']);
            }

            // Debug: Log session data
            Log::info('Session data before saving:', $data);

            // Kiểm tra dữ liệu session từng bước và redirect về đúng bước thiếu
            if (!isset($data['shop_name'])) {
                return redirect()->route('seller.register.step1')->withErrors(['error' => 'Vui lòng nhập thông tin shop.']);
            }
            if (!isset($data['shipping_options'])) {
                return redirect()->route('seller.register.step2')->withErrors(['error' => 'Vui lòng cấu hình vận chuyển.']);
            }
            if (!isset($data['business_type'])) {
                return redirect()->route('seller.register.step3')->withErrors(['error' => 'Vui lòng nhập thông tin kinh doanh.']);
            }
            if (!isset($data['identity_card'])) {
                return redirect()->route('seller.register.step4')->withErrors(['error' => 'Vui lòng nhập thông tin định danh.']);
            }
            if (!isset($data['shop_address'])) {
                return redirect()->route('seller.register.step1')->withErrors(['error' => 'Vui lòng nhập địa chỉ shop.']);
            }
            if (!isset($data['business_address'])) {
                return redirect()->route('seller.register.step3')->withErrors(['error' => 'Vui lòng nhập địa chỉ kinh doanh.']);
            }
            if (!isset($data['tax_code'])) {
                return redirect()->route('seller.register.step3')->withErrors(['error' => 'Vui lòng nhập mã số thuế.']);
            }

            DB::beginTransaction();
            try {
                // Kiểm tra số CCCD đã tồn tại chưa
                if (Seller::where('identity_card', $data['identity_card'])->exists()) {
                    // Lưu lại dữ liệu vào session để giữ form
                    session(['register_shop' => $data]);
                    return redirect()->route('seller.register.step4')->withErrors(['identity_card' => 'Số CCCD này đã được sử dụng để đăng ký. Vui lòng kiểm tra lại hoặc liên hệ hỗ trợ.']);
                }

                // 1. Lưu vào bảng shops
                $shop = Shop::create([
                    'ownerID' => Auth::id(),
                    'shop_name' => $data['shop_name'],
                    'shop_phone' => $data['shop_phone'],
                    'shop_email' => $data['shop_email'],
                    'shop_description' => $data['shop_description'],
                    'shop_logo' => $data['shop_logo'],
                    'shop_banner' => $data['shop_banner'],
                    'shop_status' => 'inactive', // Sửa từ 'pending' thành 'inactive' cho đúng enum
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                // 2. Lưu vào bảng shop_addresses
                ShopAddress::create([
                    'shopID' => $shop->id,
                    'shop_address' => $data['shop_address'],
                    'shop_province' => $data['business_province_name'] ?? '',
                    'shop_district' => $data['business_district_name'] ?? '',
                    'shop_ward' => $data['business_ward_name'] ?? '',
                    'note' => null,
                    'is_default' => 1,
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                // 3. Lưu vào bảng shop_shipping_options
                $shippingOptions = [
                    'express' => $data['shipping_options']['express']['cod_enabled'] ?? 0,
                    'fast' => $data['shipping_options']['fast']['cod_enabled'] ?? 0,
                    'economy' => $data['shipping_options']['economy']['cod_enabled'] ?? 0,
                    'self_pickup' => $data['shipping_options']['self_pickup']['cod_enabled'] ?? 0,
                    'bulky' => $data['shipping_options']['bulky']['cod_enabled'] ?? 0,
                ];
                foreach ($shippingOptions as $type => $codEnabled) {
                    ShopShippingOption::create([
                        'shopID' => $shop->id,
                        'shipping_type' => $type,
                        'cod_enabled' => $codEnabled,
                        'is_active' => 1,
                        'created_at' => now(),
                        'updated_at' => now(),
                    ]);
                }

                // 4. Lưu vào bảng business_licenses
                $businessLicense = BusinessLicense::create([
                    'business_license_number' => 'LIC' . time(),
                    'tax_number' => $data['tax_code'],
                    'business_ID' => 'BUS' . time(),
                    'business_name' => $data['shop_name'],
                    'business_type' => $data['business_type'] === 'personal' ? 'individual' : ($data['business_type'] === 'household' ? 'household' : 'company'),
                    'invoice_email' => $data['invoice_email'],
                    'business_license_date' => date('Y-m-d'),
                    'expiry_date' => date('Y-m-d', strtotime('+5 years')),
                    'status' => 'pending',
                    'license_file_path' => '', // Sửa null thành chuỗi rỗng để tránh lỗi SQL
                    'is_active' => 0,
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                // 5. Lưu vào bảng sellers
                Seller::create([
                    'userID' => Auth::id(),
                    'status' => 'suspended',
                    'identity_card' => (int)$data['identity_card'],
                    'identity_card_type' => in_array($data['identity_card_type'], ['cccd','cmnd']) ? $data['identity_card_type'] : 'cccd',
                    'identity_card_date' => $data['identity_card_date'] ? date('Y-m-d', strtotime($data['identity_card_date'])) : date('Y-m-d'),
                    'identity_card_place' => $data['identity_card_place'] ?? 'Unknown',
                    'identity_card_image' => $data['identity_card_image'] ?? '',
                    'identity_card_holding_image' => $data['identity_card_holding_image'] ?? '',
                    'privacy_policy_agreed' => $data['privacy_policy_agreed'] ?? 0,
                    'bank_account' => null,
                    'bank_name' => '',
                    'bank_account_name' => '',
                    'business_license_id' => $businessLicense->id,
                    'birth_date' => $data['birth_date'] ? date('Y-m-d', strtotime($data['birth_date'])) : null,
                    'gender' => $data['gender'] ?? null,
                    'nationality' => $data['nationality'] ?? 'Vietnam',
                    'hometown' => $data['hometown'] ?? null,
                    'residence' => $data['residence'] ?? null,
                    'dac_diem_nhan_dang' => $data['dac_diem_nhan_dang'] ?? null,
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                // 6. Lưu vào bảng identity_verifications
                IdentityVerification::create([
                    'userID' => Auth::id(),
                    'full_name' => $data['full_name'],
                    'identity_number' => $data['identity_card'],
                    'birth_date' => $data['birth_date'] ? date('Y-m-d', strtotime($data['birth_date'])) : null,
                    'nationality' => $data['nationality'] ?? 'Vietnam',
                    'gender' => $data['gender'] ?? 'other',
                    'hometown' => $data['hometown'] ?? '',
                    'residence' => $data['residence'] ?? '',
                    'identity_type' => in_array($data['identity_card_type'], ['cccd','cmnd']) ? $data['identity_card_type'] : 'cccd',
                    'identity_card_date' => $data['identity_card_date'] ? date('Y-m-d', strtotime($data['identity_card_date'])) : date('Y-m-d'),
                    'identity_card_place' => $data['identity_card_place'] ?? 'Unknown',
                    'identity_card_image' => $data['identity_card_image'] ?? '',
                    'identity_card_holding_image' => $data['identity_card_holding_image'] ?? '',
                    'status' => 'pending',
                    'rejection_reason' => null,
                    'verified_by' => null,
                    'verified_at' => null,
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                // 7. Gửi thông báo
                DB::table('notification')->insert([
                    'shop_id' => $shop->id,
                    'sender_id' => Auth::id(),
                    'receiver_user_id' => Auth::id(),
                    'title' => 'Đăng ký shop thành công',
                    'content' => 'Shop của bạn đã được tạo. Hệ thống sẽ xác thực thông tin trong 3-4 ngày làm việc. Vui lòng chờ kết quả xác thực!',
                    'type' => 'system',
                    'reference_id' => $shop->id,
                    'reference_type' => 'App\Models\Shop',
                    'priority' => 'normal',
                    'status' => 'unread',
                    'receiver_type' => 'user',
                    'read_at' => null,
                    'is_read' => 'unread',
                    'expired_at' => now()->addDays(20),
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                DB::commit();
                session()->forget('register_shop');
                return view('seller.register.finish');
            } catch (\Exception $e) {
                DB::rollBack();
                Log::error('Error saving seller registration:', [
                    'error' => $e->getMessage(),
                    'trace' => $e->getTraceAsString(),
                    'session_data' => session('register_shop')
                ]);
                session()->forget('register_shop');
                return redirect()->route('seller.register.step1')->withErrors(['error' => 'Lỗi khi lưu dữ liệu: ' . $e->getMessage()]);
            }
        }
    }

    // Helper lấy tên từ API
    private function getNameFromApi($type, $code) {
        if (!$code) return '';
        $url = '';
        if ($type === 'province') $url = "https://provinces.open-api.vn/api/p/$code";
        if ($type === 'district') $url = "https://provinces.open-api.vn/api/d/$code";
        if ($type === 'ward') {
            $url = "https://provinces.open-api.vn/api/w/$code";
        }
        try {
            $json = @file_get_contents($url);
            if ($json) {
                $data = json_decode($json, true);
                return $data['name'] ?? '';
            }
        } catch (\Exception $e) {
        }
        return '';
    }
}